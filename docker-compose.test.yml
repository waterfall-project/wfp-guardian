# Copyright (c) 2025 Waterfall
#
# This source code is dual-licensed under:
# - GNU Affero General Public License v3.0 (AGPLv3) for open source use
# - Commercial License for proprietary use
#
# See LICENSE and LICENSE.md files in the root directory for full license text.
# For commercial licensing inquiries, contact: contact@waterfall-project.pro

services:
  postgres-test:
    image: postgres:15-alpine
    container_name: wfp-postgres-test
    environment:
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpassword
      POSTGRES_DB: testdb
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U testuser -d testdb"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      test-network:
        aliases:
          - db_service

  redis-test:
    image: redis:7-alpine
    container_name: wfp-redis-test
    ports:
      - "6380:6379"
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - test-network

  identity-test:
    build:
      context: ../wfp-identity
      dockerfile: Dockerfile
    container_name: wfp-identity-test
    environment:
      FLASK_ENV: testing
      DATABASE_TYPE: postgresql
      DATABASE_HOST: postgres-test
      DATABASE_PORT: 5432
      DATABASE_NAME: testdb
      DATABASE_USER: testuser
      DATABASE_PASSWORD: testpassword
      DATABASE_URL: postgresql://testuser:testpassword@postgres-test:5432/testdb
      REDIS_HOST: redis-test
      REDIS_PORT: 6379
      SERVICE_PORT: 5001
      JWT_ALGORITHM: HS256
      JWT_SECRET: test-secret-key-shared
      LOG_LEVEL: INFO
      WAIT_FOR_DB: "true"
      RUN_MIGRATIONS: "true"
      APP_MODE: development
      USE_GUARDIAN_SERVICE: "false"
      USE_IDENTITY_SERVICE: "false"
    ports:
      - "5001:5001"
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/v0/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - test-network

  loki-test:
    image: grafana/loki:2.9.3
    container_name: wfp-loki-test
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki-test-config.yml:/etc/loki/local-config.yaml:ro
      - loki-test-data:/loki
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - test-network

  promtail-test:
    image: grafana/promtail:2.9.3
    container_name: wfp-promtail-test
    volumes:
      - ./promtail-test-config.yml:/etc/promtail/config.yml:ro
      - ./logs:/var/log/guardian:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      loki-test:
        condition: service_healthy
    networks:
      - test-network

networks:
  test-network:
    driver: bridge

volumes:
  postgres-test-data:
  redis-test-data:
  loki-test-data:
