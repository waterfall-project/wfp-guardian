name: CI - Tests & Quality

on:
  push:
    branches: [ main, staging, develop, feat/* ]
  pull_request:
    branches: [ main, staging, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.14"

jobs:
  pre-commit:
    name: Pre-commit Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run pre-commit
        run: pre-commit run --all-files

  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: make test-unit

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: unit-test-results-${{ matrix.python-version }}
          path: |
            .coverage
            htmlcov/
          if-no-files-found: ignore

# TODO: Réactiver quand wfp-identity et wfp-guardian seront publiés sur GHCR
  # integration-tests:
  #   name: Integration Tests (Python ${{ matrix.python-version }})
  #   runs-on: ubuntu-latest
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       python-version: ["3.11", "3.12", "3.13"]
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up Python ${{ matrix.python-version }}
  #       uses: actions/setup-python@v6
  #       with:
  #         python-version: ${{ matrix.python-version }}
  #         cache: 'pip'
  #
  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -e ".[dev]"
  #
  #     - name: Create test environment files
  #       run: |
  #         # .env.testing is committed
  #         # .env.integration is committed
  #         echo "Environment files ready"
  #
  #     - name: Start Docker services
  #       run: |
  #         docker compose -f docker-compose.ci.yml up -d
  #         echo "Waiting for services to be healthy..."
  #         # Pour l'instant, seulement PostgreSQL et Redis (2 services)
  #         # Quand Identity et Guardian seront disponibles, passer à 4
  #         for i in {1..12}; do
  #           HEALTHY=$(docker compose -f docker-compose.ci.yml ps | grep -c "(healthy)" || echo "0")
  #           if [ "$HEALTHY" -eq 2 ]; then
  #             echo "✓ All 2 services are healthy"
  #             break
  #           fi
  #           echo "  Waiting... ($HEALTHY/2 services healthy)"
  #           sleep 5
  #           if [ $i -eq 12 ]; then
  #             echo "⚠️  Timeout: Not all services became healthy"
  #             docker compose -f docker-compose.ci.yml ps
  #             docker compose -f docker-compose.ci.yml logs
  #             exit 1
  #           fi
  #         done
  #
  #     - name: Run integration tests with coverage
  #       run: make test-cov
  #
  #     - name: Stop Docker services
  #       if: always()
  #       run: docker compose -f docker-compose.ci.yml down
  #
  #     - name: Upload coverage reports
  #       if: matrix.python-version == '3.13'
  #       uses: actions/upload-artifact@v6
  #       with:
  #         name: coverage-report
  #         path: |
  #           .coverage
  #           htmlcov/
  #           coverage.xml
  #
  #     - name: Upload test results
  #       if: always()
  #       uses: actions/upload-artifact@v6
  #       with:
  #         name: integration-test-results-${{ matrix.python-version }}
  #         path: htmlcov/

  # TODO: Réactiver quand les tests d'intégration seront décommentés
  # coverage:
  #   name: Coverage Report
  #   runs-on: ubuntu-latest
  #   needs: [integration-tests]
  #   if: always()
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Download coverage report
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: coverage-report
  #
  #     - name: Display coverage report
  #       run: |
  #         pip install coverage
  #         coverage report
  #
  #     - name: Check coverage threshold
  #       run: |
  #         pip install coverage
  #         COVERAGE=$(coverage report | tail -1 | awk '{print $4}' | sed 's/%//')
  #         echo "Current coverage: ${COVERAGE}%"
  #         if (( $(echo "$COVERAGE < 90" | bc -l) )); then
  #           echo "❌ Coverage is below 90% threshold"
  #           exit 1
  #         fi
  #         echo "✅ Coverage is above 90% threshold"
  #
  #     - name: Generate coverage badge
  #       if: github.ref == 'refs/heads/main'
  #       run: |
  #         pip install genbadge[coverage]
  #         coverage xml
  #         genbadge coverage -i coverage.xml -o coverage-badge.svg
  #
  #     - name: Upload coverage badge
  #       if: github.ref == 'refs/heads/main'
  #       uses: actions/upload-artifact@v6
  #       with:
  #         name: coverage-badge
  #         path: coverage-badge.svg

  docstring-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Check docstring coverage
        run: make docstring-check

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [pre-commit, unit-tests, docstring-check]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "Pre-commit: ${{ needs.pre-commit.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          # echo "Integration Tests: ${{ needs.integration-tests.result }}"
          # echo "Coverage: ${{ needs.coverage.result }}"
          echo "Docstring Check: ${{ needs.docstring-check.result }}"

          if [[ "${{ needs.pre-commit.result }}" != "success" ]] || \
             [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.docstring-check.result }}" != "success" ]]; then
            # [[ "${{ needs.integration-tests.result }}" != "success" ]] || \
            # [[ "${{ needs.coverage.result }}" != "success" ]] || \
            exit 1
          fi

          echo "✅ All CI checks passed"
