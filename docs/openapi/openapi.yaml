openapi: 3.0.3
info:
  title: Guardian Service API
  version: 0.0.1
  description: |
    **Waterfall Guardian API** - Centralized Authorization Service for the Waterfall Platform.

    This service is the single source of truth for permissions and access control within the Waterfall ecosystem.
    It implements a comprehensive Role-Based Access Control (RBAC) system with fine-grained policies.

    **Key Features**:
    - **Access Control**: High-performance permission checks (`/check-access`) with caching.
    - **RBAC Management**: Full lifecycle management for Roles, Policies, and Permissions.
    - **User Assignments**: Manage user roles within companies and projects.
    - **Audit Trail**: Comprehensive access logs for security and compliance.
    - **System Bootstrap**: Automated initialization for new tenants.

    **Integrations**:
    - **Identity Service**: Consumes user and company events.
    - **Redis**: Distributed caching for low-latency access checks.
    - **PostgreSQL**: Persistent storage for RBAC configuration and audit logs.

  contact:
    name: Waterfall Team
    email: contact@waterfall-project.pro
  license:
    name: AGPL-3.0 + Proprietary
    url: https://www.gnu.org/licenses/agpl-3.0.html

servers:
  - url: http://localhost:8000/v0
    description: Local development server
  - url: http://guardian:8000/v0
    description: Docker Compose
  - url: https://guardian.waterfall-project.pro
    description: Production

tags:
  - name: System
    description: Health checks, monitoring, configuration
  - name: Access Control
    description: Permission checks and user permissions retrieval
  - name: Roles
    description: Role management (CRUD operations)
  - name: Policies
    description: Policy management and permission assignments
  - name: Permissions
    description: Permission definitions (read-only, seeded by system)
  - name: User Roles
    description: User role assignments within companies and projects
  - name: Audit
    description: Access logs for security and compliance
  - name: Bootstrap
    description: System initialization for new tenants

paths:
  # System endpoints
  /health:
    $ref: './paths/system.yaml#/~1health'
  /ready:
    $ref: './paths/system.yaml#/~1ready'
  /version:
    $ref: './paths/system.yaml#/~1version'
  /configuration:
    $ref: './paths/system.yaml#/~1configuration'
  /metrics:
    $ref: './paths/system.yaml#/~1metrics'

  # Access Control endpoints
  /check-access:
    $ref: './paths/access.yaml#/~1check-access'
  /batch-check-access:
    $ref: './paths/access.yaml#/~1batch-check-access'
  /users/{user_id}/permissions:
    $ref: './paths/access.yaml#/~1users~1{user_id}~1permissions'

  # Role Management endpoints
  /roles:
    $ref: './paths/roles.yaml#/~1roles'
  /roles/{role_id}:
    $ref: './paths/roles.yaml#/~1roles~1{role_id}'
  /roles/{role_id}/policies:
    $ref: './paths/roles.yaml#/~1roles~1{role_id}~1policies'
  /roles/{role_id}/policies/{policy_id}:
    $ref: './paths/roles.yaml#/~1roles~1{role_id}~1policies~1{policy_id}'

  # Policy Management endpoints
  /policies:
    $ref: './paths/policies.yaml#/~1policies'
  /policies/{policy_id}:
    $ref: './paths/policies.yaml#/~1policies~1{policy_id}'
  /policies/{policy_id}/permissions:
    $ref: './paths/policies.yaml#/~1policies~1{policy_id}~1permissions'
  /policies/{policy_id}/permissions/{permission_id}:
    $ref: './paths/policies.yaml#/~1policies~1{policy_id}~1permissions~1{permission_id}'

  # Permission Management endpoints
  /permissions:
    $ref: './paths/permissions.yaml#/~1permissions'
  /permissions/by-service:
    $ref: './paths/permissions.yaml#/~1permissions~1by-service'
  /permissions/{permission_id}:
    $ref: './paths/permissions.yaml#/~1permissions~1{permission_id}'

  # User Role Management endpoints
  /users/{user_id}/roles:
    $ref: './paths/user_roles.yaml#/~1users~1{user_id}~1roles'
  /users/{user_id}/roles/{user_role_id}:
    $ref: './paths/user_roles.yaml#/~1users~1{user_id}~1roles~1{user_role_id}'
  /roles/{role_id}/users:
    $ref: './paths/user_roles.yaml#/~1roles~1{role_id}~1users'

  # Audit endpoints
  /access-logs:
    $ref: './paths/audit.yaml#/~1access-logs'
  /access-logs/{log_id}:
    $ref: './paths/audit.yaml#/~1access-logs~1{log_id}'
  /access-logs/statistics:
    $ref: './paths/audit.yaml#/~1access-logs~1statistics'

  # Bootstrap endpoints
  /bootstrap:
    $ref: './paths/bootstrap.yaml#/~1bootstrap'
  /companies/{company_id}/init-roles:
    $ref: './paths/bootstrap.yaml#/~1companies~1{company_id}~1init-roles'

components:
  securitySchemes:
    JWTAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token passed via HTTP-only cookies containing company_id and user_id

        **JWT Claims**:
        - `user_id` (UUID): Unique user identifier
        - `company_id` (UUID): Company identifier (multi-tenant)
        - `email` (string): User email
        - `exp` (timestamp): Token expiration date
        - `iat` (timestamp): Token issued at date

    InternalToken:
      type: apiKey
      in: header
      name: X-Internal-Token
      description: |
        Internal service-to-service authentication token.

        Used for endpoints called by other Waterfall services (Identity, etc.).
        Must match the `INTERNAL_SERVICE_TOKEN` environment variable.

security:
  - JWTAuth: []
